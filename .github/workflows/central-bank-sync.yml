name: Central Bank Harvester (X-Twitter Mode)

on:
  workflow_run:
    workflows: ["Get Tweet ID", "Get Home Latest Timeline"]
    types: [completed]
  workflow_dispatch: 

jobs:
  harvest-to-bank:
    runs-on: ubuntu-latest
    # 只有当前置任务成功，或手动触发时才执行
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout Source (x-data)
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_TOKEN }} # 确保 token 名字正确且有写入权限
          path: temp_src

      - name: Checkout Central Bank
        uses: actions/checkout@v3
        with:
          repository: ${{ secrets.CENTRAL_BANK_REPO }}
          token: ${{ secrets.MY_PAT }}
          path: central_bank

      # --- 关键修复：在此 Job 中安装 Bun ---
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install Dependencies
        working-directory: ./temp_src
        run: bun install

      - name: Sync Old Data
        working-directory: ./temp_src
        run: |
          # 运行筛选同步脚本：它只搬运 1-29 的旧文件，保留 1-30 的新空间
          bun run scripts/sync-to-bank.ts

      - name: Push to Central Bank
        working-directory: ./central_bank
        run: |
          git config --global user.name 'Architect Bot'
          git config --global user.email 'bot@architect.alpha'
          git add .
          # 检查是否有新文件需要提交
          git commit -m "archive: sync historical data to bank [$(date +%Y-%m-%d)]" || exit 0
          git push

      - name: Commit Source Cleanup
        working-directory: ./temp_src
        run: |
          git config --global user.name 'Architect Bot'
          git config --global user.email 'bot@architect.alpha'
          git add .
          # 脚本已经通过 unlink 删除了旧文件，这里提交本地仓库的变动
          git commit -m "chore: cleanup archived data [skip ci]" || exit 0
          git push
